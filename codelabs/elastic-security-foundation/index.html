
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Elastic 安全实战工作坊(中等)</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-749876-6"></google-codelab-analytics>
  <google-codelab codelab-gaid="UA-159133967-1"
                  id="elastic-security-foundation"
                  title="Elastic 安全实战工作坊(中等)"
                  environment="web"
                  feedback-link="https://martinliu.cn">
    
      <google-codelab-step label="概述" duration="5">
        <p>用 Elastic Security 来武装每一位安全运维人员，从容的预防、检测和应对网络威胁。这款免费开放的解决方案提供了 SIEM、端点安全、威胁狩猎、云监控、恶意软件保护等功能。在这个课程中，您将学习如何利用 Elastic Security 的 SIEM 功能和威胁检测功能来为您的安全运维保驾护航。</p>
<p>本课程专为安全分析师（SecOps），和其它对此感兴趣工程师而设计。希望你在本课程中体验到运用 Elastic Security 进行安全运维的一天。你将学习到如何使用 Elastic Security 来可视化数据，配置数据摄入，并应用规则检测引擎。在本课程结束时，你将全面掌握使用 Elastic Security 来检测基础设施威胁的工作方法，能够运用 Elasticsearch 的快速搜索进行实时的安全防护和响应。</p>
<p>在本课程中您将会学到：</p>
<ol type="1">
<li>在单节点 Linux 服务器上搭建 Elasticsearch + Kibana 服务。</li>
<li>学习使用 Elastic Stack 进行安全管理的基本概念和方案架构。</li>
<li>使用 Elastic 提供的 Auditbeat、 Filebeat 和 PacketBeat 摄入数据。</li>
<li>部署和接入外部开源 IDS 软件 Scatea 的监控数据</li>
<li>学习使用 Elastic Security 提供的时间线事件分析工具</li>
<li>启用和配置内置的安全监测规则，实施 MITRE ATT&amp;CK 安全威胁狩猎</li>
<li>应用机器学习的异常监测能力自动化和增强安全巡检</li>
</ol>
<h2 is-upgraded>Elastic Security 安全方案架构</h2>
<p class="image-container"><img alt="2021-03-18_11-39-47-6075057" src="img/e8b6c190ba617b89.png"></p>
<p>本课程所使用到的 Elastic Stack 的组件包括：</p>
<ul>
<li>Elasticsearch、Kibana、Packetbeat、Filebeat、Auditbeat 版本是 7.11. 2。</li>
<li>Suricata 版本 5.0.6，开源入侵监测引擎。</li>
</ul>
<h2 is-upgraded>安全管理旅程的四个阶段</h2>
<p>网络信息安全管理方案的复杂性和成本是有目共睹的，通常安全相关工作由安全管理团队专人专职负责，他们运用各种专业技能和工具开展日常的工作。Elasticsearch 在安全领域是经常被使用到的搜索和分析平台。Elastic 在最近几年着重发展了对安全管理的支持。用户可以在已有的 Elastic Stack 的技能的基础上，平滑的扩展到安全管理使用场景，复用现有的技能和 ELK 基础设施解决安全管理的痛点。</p>
<p class="image-container"><img alt="2021-03-18_17-30-58-6075133" src="img/4f02c0d3f51fd49.png"></p>
<p>分阶段的开展安全管理的推荐过程如下：</p>
<ol type="1">
<li>STEP1：使用 Beats  按需收集各种安全事件</li>
<li>STEP2：使用 SIEM 功能开展 SOC 日常安全运维工作，Kibana 作为统一的搜索分析工具</li>
<li>STEP3：基于内置的安全监测规则，自动化威胁检测和告警机制</li>
<li>STEP4：与外部安全管理工具系统集成，完成无盲区的安全事故检测响应全工作流程</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="系统准备" duration="15">
        <p>启动一个 CentOS 8 Linux 虚拟机，内存建议至少 4GB，推荐 6GB。</p>
<h2 is-upgraded>安装配置 Elasticsearch</h2>
<p>假设所有安装包和配置文件都位于 <code>/vagrant</code> 目录下</p>
<pre><code language="language-shell" class="language-shell">cd /vagrant/rpm
sudo rpm -ivh  ./elasticsearch-7.11.2-x86_64.rpm
</code></pre>
<p>创建 TLS 数字证书</p>
<pre><code language="language-shell" class="language-shell">sudo /usr/share/elasticsearch/bin/elasticsearch-certutil cert -out /etc/elasticsearch/elastic-certificates.p12 -pass &#34;&#34;
sudo chmod 660 /etc/elasticsearch/elastic-certificates.p12
sudo ls -l /etc/elasticsearch/elastic-certificates.p12
</code></pre>
<p>更新 Elasticsearch 配置文件为一下内容。</p>
<pre><code language="language-yaml" class="language-yaml"># ---------------------------------- Cluster -----------------------------------
cluster.name: elk-security

# ----------------------------------- Paths ------------------------------------
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

# ---------------------------------- Network -----------------------------------
network.host: 0.0.0.0

# --------------------------------- Discovery ----------------------------------
discovery.type: single-node

# ------------------------------- TLS and Cert ---------------------------------
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: elastic-certificates.p12
</code></pre>
<p>上见示例配置文件 sec-2.yml</p>
<p>用以上内容替换默认 elasticsearch.yml 文件的内容。然后重启 Elasticsearch 服务。</p>
<pre><code language="language-sh" class="language-sh">sudo cp /vagrant/sec-2.yml /etc/elasticsearch/elasticsearch.yml
sudo systemctl daemon-reload
sudo systemctl enable elasticsearch.service
sudo systemctl start elasticsearch.service
sudo systemctl status elasticsearch
</code></pre>
<p>使用 <code>sudo tail -f /var/log/elasticsearch/elk-security.log</code> 命令查看当前 Elasticsearch 服务的日志。</p>
<p>初始化 ES 服务器内建用户的密码，这些密码需要在控制台上复制保存备用。</p>
<pre><code language="language-shell" class="language-shell">sudo /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -b
</code></pre>
<p>以上命令的输出如下：</p>
<pre><code language="language-shell" class="language-shell">Changed password for user apm_system
PASSWORD apm_system = MxKeoXQrHjG0uiVMvHZC

Changed password for user kibana_system
PASSWORD kibana_system = 0Vd8sJ8s6vIqOkUhD406

Changed password for user kibana
PASSWORD kibana = 0Vd8sJ8s6vIqOkUhD406

Changed password for user logstash_system
PASSWORD logstash_system = 1Cvgip4QIq9VNnz6lcPc

Changed password for user beats_system
PASSWORD beats_system = bqfuocxvzENOUtGgLWpc

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = amncUjSCzIL0a89Twn2K

Changed password for user elastic
PASSWORD elastic = V4CQNvnBpQUI1Bc2Ty1M
</code></pre>
<p>在浏览器中访问http://192.168.50.11:9200/ ，测试并确认上面的 elastic 用户的密码。</p>
<h2 is-upgraded>安装配置 Kibana</h2>
<p>执行 Kibana 安装命令</p>
<pre><code language="language-shell" class="language-shell">cd /vagrant/rpm/
sudo rpm -ivh  kibana-7.11.2-x86_64.rpm
</code></pre>
<p>准备 Kibana 的配置文件，如下：</p>
<pre><code language="language-yaml" class="language-yaml">server.host: 192.168.50.11
server.port: 5601
elasticsearch.hosts: [&#34;http://192.168.50.11:9200&#34;]
elasticsearch.username: elastic
elasticsearch.password: V4CQNvnBpQUI1Bc2Ty1M
i18n.locale: zh-CN
xpack.security.enabled: true
xpack.security.encryptionKey: &#34;fhjskloppd678ehkdfdlliverpoolfcr&#34;
xpack.encryptedSavedObjects.encryptionKey: &#34;Si0gjCjujZ0LghDiApKJfGhGeVJ8JwxrY1z7rOpBva&#34;
xpack.fleet.agents.tlsCheckDisabled: true
</code></pre>
<p>上见示例配置文件 sec-3.yml</p>
<p>更新默认配置文件，用以上示例配置文件覆盖 Kibana 默认配置文件。</p>
<pre><code language="language-shell" class="language-shell">sudo cp /vagrant/sec-3.yml /etc/kibana/kibana.yml
sudo systemctl start  kibana.service
sudo systemctl status   kibana.service
</code></pre>
<p>查看重启的服务是否工作正常。</p>
<pre><code language="language-shell" class="language-shell">sudo tail -f /var/log/messages
</code></pre>
<p>在浏览器里测试登录 Kibana http://192.168.50.11:5601 ，使用 elastic 的用户名和密码。应该看到如下的界面。</p>
<p class="image-container"><img alt="2021-03-24_13-13-23" src="img/9f1c02938474b18b.png"></p>
<p>创建一个用于解析 IP 地址地理位置的 pipeline</p>
<pre><code language="language-json" class="language-json">PUT _ingest/pipeline/geoip-info
{
  &#34;description&#34;: &#34;Add geoip info&#34;,
  &#34;processors&#34;: [
    {
      &#34;geoip&#34;: {
        &#34;field&#34;: &#34;client.ip&#34;,
        &#34;target_field&#34;: &#34;client.geo&#34;,
        &#34;ignore_missing&#34;: true
      }
    },
    {
      &#34;geoip&#34;: {
        &#34;field&#34;: &#34;source.ip&#34;,
        &#34;target_field&#34;: &#34;source.geo&#34;,
        &#34;ignore_missing&#34;: true
      }
    },
    {
      &#34;geoip&#34;: {
        &#34;field&#34;: &#34;destination.ip&#34;,
        &#34;target_field&#34;: &#34;destination.geo&#34;,
        &#34;ignore_missing&#34;: true
      }
    },
    {
      &#34;geoip&#34;: {
        &#34;field&#34;: &#34;server.ip&#34;,
        &#34;target_field&#34;: &#34;server.geo&#34;,
        &#34;ignore_missing&#34;: true
      }
    },
    {
      &#34;geoip&#34;: {
        &#34;field&#34;: &#34;host.ip&#34;,
        &#34;target_field&#34;: &#34;host.geo&#34;,
        &#34;ignore_missing&#34;: true
      }
    }
  ]
}

 GET _ingest/pipeline/geoip-info
</code></pre>
<p class="image-container"><img alt="2021-03-24_14-26-10" src="img/18e5c0ae6c62212c.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="安全事件收集" duration="30">
        <h2 is-upgraded>安装配置 Auditbeat</h2>
<p>sudo rpm -ivh /vagrant/rpm/auditbeat-7.11.2-x86_64.rpm</p>
<p>sudo auditbeat setup -e \   -E output.logstash.enabled=false \   -E output.elasticsearch.hosts=[‘192.168.50.11:9200&#39;] \   -E output.elasticsearch.username=elastic \   -E output.elasticsearch.password=V4CQNvnBpQUI1Bc2Ty1M\   -E setup.kibana.host=http://192.168.50.11:5601</p>
<pre><code language="language-yaml" class="language-yaml">auditbeat.modules:
- module: auditd
  audit_rule_files: [ &#39;${path.config}/audit.rules.d/*.conf&#39; ]
  audit_rules: |
- module: file_integrity
  paths:
  - /bin
  - /usr/bin
  - /sbin
  - /usr/sbin
  - /etc
- module: system
  datasets:
    - package # Installed, updated, and removed packages
      period: 2m # The frequency at which the datasets check for changes
- module: system
  datasets:
    - host    # General host information, e.g. uptime, IPs
    - login   # User logins, logouts, and system boots.
    - process # Started and stopped processes
    - socket  # Opened and closed sockets
    - user    # User information
      user.detect_password_changes: true
      login.wtmp_file_pattern: /var/log/wtmp*
      login.btmp_file_pattern: /var/log/btmp*

tags: [&#34;service-siem&#34;, &#34;vagrant-vm&#34;]
fields:
  env: workshop

output.elasticsearch:
  hosts: [&#34;192.168.50.11:9200&#34;]
  username: elastic
  password:  V4CQNvnBpQUI1Bc2Ty1M
  pipeline:  geoip-info

processors:
  - add_host_metadata:
    netinfo.enabled: false
    geo:
      location: 35.5528, 116.2360
      continent_name: Asia
      country_iso_code: CN
      region_name: Beijing
      region_iso_code: CN-BJ
      city_name: Beijing
      name: myCyberSecLab
  - add_locale: ~
  - add_fields:
    when.network.source.ip: private
    fields:
      source.geo.location:
        lat: 35.5528
        lon: 116.2360
      source.geo.continent_name: Asia
      source.geo.country_iso_code: CN
      source.geo.region_name: Beijing
      source.geo.region_iso_code: CN-BJ
      source.geo.city_name: Beijing
      source.geo.name: myCyberSecLab
    target: &#39;&#39;
  - add_fields:
    when.network.destination.ip: private
    fields:
      destination.geo.location:
        lat: 35.5528
        lon: 116.2360
      destination.geo.continent_name: Asia
      destination.geo.country_iso_code: CN
      destination.geo.region_name: Beijing
      destination.geo.region_iso_code: CN-BJ
      destination.geo.city_name: Beijing
      destination.geo.name: myCyberSecLab
    target: &#39;&#39;

setup.ilm.check_exists: false
logging.level: error
queue.spool: ~
monitoring.enabled: true
</code></pre>
<p>sudo cp /vagrant/sec-4.yml /etc/auditbeat/auditbeat.yml sudo systemctl start  auditbeat sudo systemctl status   auditbeat</p>
<h2 is-upgraded>安装配置 Pecketbeat</h2>
<p>sudo rpm -ivh /vagrant/rpm/packetbeat-7.11.2-x86_64.rpm</p>
<p>sudo packetbeat setup -e \   -E output.logstash.enabled=false \   -E output.elasticsearch.hosts=[‘192.168.50.11:9200&#39;] \   -E output.elasticsearch.username=elastic \   -E output.elasticsearch.password=V4CQNvnBpQUI1Bc2Ty1M\   -E setup.kibana.host=http://192.168.50.11:5601</p>
<pre><code language="language-yaml" class="language-yaml">#=== Packetbeat specific options ===
#=== Network device ===
# Select the network interface to sniff the data. On Linux, you can use the
# &#34;any&#34; keyword to sniff on all connected interfaces.
packetbeat.interfaces.device: any
#=== Flows ===
packetbeat.flows:
  timeout: 30s
  period: 10s
#=== Transaction protocols ===
# For more information on the transaction protocols, see
# https://www.elastic.co/guide/en/beats/packetbeat/7.4/configuration-protocols.html
packetbeat.protocols:
- type: icmp
  # Enable ICMPv4 and ICMPv6 monitoring. Default: false
  enabled: true
- type: dhcpv4
  # Configure the DHCP for IPv4 ports.
  ports: [67, 68]
  send_request: true
  send_response: true
- type: dns
  # Configure the ports where to listen for DNS traffic. You can disable
  # the DNS protocol by commenting out the list of ports.
  ports: [53]
  include_authorities: true
  include_additionals: true
  send_request: true
  send_response: true
- type: http
  # Configure the ports where to listen for HTTP traffic. You can disable
  # the HTTP protocol by commenting out the list of ports.
  ports: [80, 8080, 8000, 5000, 8002]
- type: tls
  # Configure the ports where to listen for TLS traffic. You can disable
  # the TLS protocol by commenting out the list of ports.
  ports:
    - 443   # HTTPS
    - 993   # IMAPS
    - 995   # POP3S
    - 5223  # XMPP over SSL
    - 8443
    - 8883  # Secure MQTT
    - 9243  # Elasticsearch

tags: [&#34;service-siem&#34;, &#34;vagrant-vm&#34;]
fields:
  env: workshop

output.elasticsearch:
  hosts: [&#34;192.168.50.11:9200&#34;]
  username: elastic
  password:  V4CQNvnBpQUI1Bc2Ty1M
  pipeline:  geoip-info

processors:
  - add_host_metadata:
      netinfo.enabled: false
      geo:
        location: 35.5528, 116.2360
        continent_name: Asia
        country_iso_code: CN
        region_name: Beijing
        region_iso_code: CN-BJ
        city_name: Beijing
        name: myCyberSecLab
  - add_locale: ~
  - add_fields:
      when.network.source.ip: private
      fields:
        source.geo.location:
          lat: 35.5528
          lon: 116.2360
        source.geo.continent_name: Asia
        source.geo.country_iso_code: CN
        source.geo.region_name: Beijing
        source.geo.region_iso_code: CN-BJ
        source.geo.city_name: Beijing
        source.geo.name: myCyberSecLab
      target: &#39;&#39;
  - add_fields:
      when.network.destination.ip: private
      fields:
        destination.geo.location:
          lat: 35.5528
          lon: 116.2360
        destination.geo.continent_name: Asia
        destination.geo.country_iso_code: CN
        destination.geo.region_name: Beijing
        destination.geo.region_iso_code: CN-BJ
        destination.geo.city_name: Beijing
        destination.geo.name: myCyberSecLab
      target: &#39;&#39;

setup.ilm.check_exists: false
logging.level: error
queue.spool: ~
monitoring.enabled: true
</code></pre>
<p>sudo cp /vagrant/sec-5.yml /etc/packetbeat/packetbeat.yml sudo systemctl start  packetbeat sudo systemctl status   packetbeat</p>
<p>ping www.goo.ne.jp</p>
<h2 is-upgraded>安装配置 Filebeat</h2>
<p>sudo rpm -ivh /vagrant/rpm/filebeat-7.11.2-x86_64.rpm</p>
<p>sudo filebeat setup -e \   -E output.logstash.enabled=false \   -E output.elasticsearch.hosts=[‘192.168.50.11:9200&#39;] \   -E output.elasticsearch.username=elastic \   -E output.elasticsearch.password=V4CQNvnBpQUI1Bc2Ty1M\   -E setup.kibana.host=http://192.168.50.11:5601</p>
<p>sudo filebeat modules enable system</p>
<p>sudo filebeat modules list</p>
<pre><code language="language-yaml" class="language-yaml">#=========================== Filebeat inputs =============================
filebeat.inputs:
- type: log
  enabled: false
  paths:
    - /var/log/*.log

#============================= Filebeat modules ===============================
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 60s

tags: [&#34;service-siem&#34;, &#34;vagrant-vm&#34;]
fields:
  env: workshop

output.elasticsearch:
  hosts: [&#34;192.168.50.11:9200&#34;]
  username: elastic
  password:  V4CQNvnBpQUI1Bc2Ty1M
  pipeline:  geoip-info

processors:
  - add_host_metadata:
      netinfo.enabled: false
      geo:
        location: 35.5528, 116.2360
        continent_name: Asia
        country_iso_code: CN
        region_name: Beijing
        region_iso_code: CN-BJ
        city_name: Beijing
        name: myCyberSecLab
  - add_locale: ~
  - add_fields:
      when.network.source.ip: private
      fields:
        source.geo.location:
          lat: 35.5528
          lon: 116.2360
        source.geo.continent_name: Asia
        source.geo.country_iso_code: CN
        source.geo.region_name: Beijing
        source.geo.region_iso_code: CN-BJ
        source.geo.city_name: Beijing
        source.geo.name: myCyberSecLab
      target: &#39;&#39;
  - add_fields:
      when.network.destination.ip: private
      fields:
        destination.geo.location:
          lat: 35.5528
          lon: 116.2360
        destination.geo.continent_name: Asia
        destination.geo.country_iso_code: CN
        destination.geo.region_name: Beijing
        destination.geo.region_iso_code: CN-BJ
        destination.geo.city_name: Beijing
        destination.geo.name: myCyberSecLab
      target: &#39;&#39;

setup.ilm.check_exists: false
logging.level: error
queue.spool: ~
monitoring.enabled: true
</code></pre>
<p>sudo cp /vagrant/sec-6.yml /etc/filebeat/filebeat.yml sudo systemctl start  filebeat sudo systemctl status   filebeat</p>


      </google-codelab-step>
    
      <google-codelab-step label="SecOps巡检和分析" duration="15">
        <p>Interactive Terminal Spawned via Python</p>


      </google-codelab-step>
    
      <google-codelab-step label="安全威胁狩猎" duration="10">
        <p>加载规则</p>
<h3 is-upgraded>启用检测规则</h3>
<p>创建和测试 winrar 在 SQL 服务器上压缩文件的场景</p>


      </google-codelab-step>
    
      <google-codelab-step label="外部系统集成" duration="20">
        <p>sudo yum -y install epel-release sudo yum -y install suricata</p>
<p>sudo suricata-update</p>
<p>/etc/sysconfig/suricata</p>
<p>eth0  eth1</p>
<p>vi /etc/suricata/suricata.yaml</p>
<p>vars:</p>
<p>more specific is better for alert accuracy and performance</p>
<p>address-groups:</p>
<pre><code>HOME_NET: &#34;[192.168.50.0/24,10.0.2.0/24]&#34;
</code></pre>
<p>sudo systemctl start suricata</p>
<p>sudo filebeat modules enable suricata</p>
<p>Perform SSH DDoS Test Attack On another system, install hping3 tool and perform an SSH DDoS test attack.</p>
<p>sudo dnf  -y install hping3 Then attack SSH on the server running Suricata.</p>
<p>hping3 -S -p 22 –flood –rand-source 192.168.50.11 Refer to man hping3.</p>
<p>While hping is running, tail the alert logs on Suricata server;</p>
<p>sudo tail -f /var/log/suricata/fast.log</p>
<pre><code>sudo tail -f /var/log/suricata/fast.log
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="机器学习加持安全管理" duration="5">
        

      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
