<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Elastic Stack Fleet 服务器配置指南（v8.5） - Elastic Stack Workshop | 刘征 Developer Advocate @ Elastic</title><meta name=description content="Elastic Stack Fleet 服务器配置指南（v8.5）"><meta name=generator content="Hugo 0.105.0"><link href=https://elastic.martinliu.cn//index.xml rel=alternate type=application/rss+xml><link rel=canonical href=https://elastic.martinliu.cn/chapter3/chapter3-1/5/><link rel=stylesheet href=https://elastic.martinliu.cn/css/theme.min.css><script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script>
<link rel=stylesheet href=https://elastic.martinliu.cn/css/chroma.min.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>
<script src=https://elastic.martinliu.cn/js/bundle.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-77731594-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-77731594-1")</script><style>:root{--custom-background-color:rgb(0,191,179)}</style><meta property="og:title" content="Elastic Stack Fleet 服务器配置指南（v8.5）"><meta property="og:description" content="Elastic Stack Fleet 服务器配置指南（v8.5）"><meta property="og:type" content="article"><meta property="og:url" content="https://elastic.martinliu.cn/chapter3/chapter3-1/5/"><meta property="og:image" content="https://elastic.martinliu.cn/images/elastic-stack-logo.png"><meta property="article:section" content="chapter3"><meta property="article:published_time" content="2022-11-06T20:41:32+08:00"><meta property="article:modified_time" content="2022-11-06T17:41:32+08:00"><meta property="og:site_name" content="Elastic Stack Workshop"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://elastic.martinliu.cn/images/elastic-stack-logo.png"><meta name=twitter:title content="Elastic Stack Fleet 服务器配置指南（v8.5）"><meta name=twitter:description content="Elastic Stack Fleet 服务器配置指南（v8.5）"><meta itemprop=name content="Elastic Stack Fleet 服务器配置指南（v8.5）"><meta itemprop=description content="Elastic Stack Fleet 服务器配置指南（v8.5）"><meta itemprop=datePublished content="2022-11-06T20:41:32+08:00"><meta itemprop=dateModified content="2022-11-06T17:41:32+08:00"><meta itemprop=wordCount content="4468"><meta itemprop=image content="https://elastic.martinliu.cn/images/elastic-stack-logo.png"><meta itemprop=keywords content><script src=/js/elastic-apm-rum.umd.min.js></script>
<script>elasticApm.init({serviceName:"Elastic-Stack-Workshop",environment:"production",serviceVersion:"1.2.3",breakdownMetrics:"true",serverUrl:"https://b1c7fb0e25894d4db3cabb678546c24f.apm.ap-east-1.aws.elastic-cloud.com:443"})</script></head><body><div class=container><header><h1>Elastic Stack Workshop | 刘征 Developer Advocate @ Elastic</h1><span class=version>Version 0.2.5</span><a href=https://github.com/martinliu/elasticstack-workshop class=github><i class="fab fa-github"></i></a><p class=description>搜索、观测、保护三大解决方案实战教程，各种级别和类型的学习资料，欢迎一起学习和共建。</p></header><div class=global-menu><nav><ul><li><a href=/>首页</a></li><li><a href=https://martinliu.cn>博客</a></li><li><a href=/workshop/>教程</a></li><li><a href=/contribution/>贡献</a></li></ul></nav></div><div class=content-container><main><h1>Elastic Stack Fleet 服务器配置指南（v8.5）</h1><p>在本课程中您将会学到：</p><ol><li>7.4 版本后 Fleet 采集中间层服务器基本定型，正在发挥着巨大的作用</li><li>Elastic Agent 正在逐步成为万金油式的边缘端管理工具</li><li>熟悉掌握 Elasticsearch & Kibana 最新的安全配置模型</li><li>Fleet 服务器的部署，用策略集中式实现 Elastic Agent 采集日志和指标的工作</li><li>搭建本地采集代理程序安装包下载服务器，为简化测试环境</li><li>体验可观测性和安全管理方案的开箱即用功能</li></ol><p><img src=/images/2022-10-17_23-36-03.png alt="7.14 后的架构图"></p><p>核心组件概述：</p><ul><li>Elastic Agent ： 是一个万能安装配置工具，它既可以安装部署 Fleet server ，也在被管理节点上部署各种 Beats 采集端程序，这就意味着你再也不用手工的安装配置运行多个不同 Beats 程序了。</li><li>Fleet server ： 批量管理所有被管理节点（采集端服务器）的策略分发服务器，它负责注册节点接入新的被管理服务器，并持续更新维护所有后续的配置变更。</li><li>Fleet app【 Kibana 端】 ：Kibana 提供了对 Fleet 服务器，及以下所有被管理节点的控制平面。包括 Policy Builder 管理策略构建器和 Package Manager 包管理器两个部分。</li><li>Elasticsearch ：存储所有代理管理策略，采集代理程序和 Fleet 服务器所需要的安装包配置信息。</li><li>Elastic Agent 【FB Filebeat ，MB Metricbeat 日志，指标等采集代理】：向 Fleet server 定期报到，并查看是否有代理策略更新；如果有新的 Beat 需要安装，从策略中指定的 ‘安装包下载服务器’ 下载并安装新的组件，将采集到的数据发送到 Elasticsearch 服务器。</li><li>Elastic Package Registry : 所有可以被 Elastic Agent 管理的组件程序都需要特定的安装方式和可参数化配置，从 Elastic 官方网站下载，也可以用 Docker 方式在内网建立中继服务器。</li></ul><p>本教程的示例测试环境：</p><ul><li>虚拟机 A ：Red Hat Enterprise Linux OS - 192.168.10.113 ， 用于安装 Elasticsearch ， Kibana ，Fleet 服务器， Beats 安装包下载服务器。</li><li>虚拟机 B Red Hat Enterprise Linux OS - 192.168.10.135 ， 用于使用 Elastic Agent 部署各种 Beats 实现各种采集功能。</li></ul><h2 id=安装-elasticsearch>安装 Elasticsearch</h2><p>在虚拟机 A 上完成本章节操作。</p><p>SSH 登录到操作系统，下载 Elasticsearch 的 rpm 安装包，用 rpm 的方式安装 Elasticssearch 服务器 <code>dnf install -y elasticsearch-8.5.0-x86_64.rpm</code> 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@elk-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># dnf install elasticsearch-8.5.0-x86_64.rpm </span>
</span></span><span style=display:flex><span>Updating Subscription Management repositories.
</span></span><span style=display:flex><span>Red Hat Enterprise Linux <span style=color:#ae81ff>9</span> <span style=color:#66d9ef>for</span> x86_64 - BaseOS <span style=color:#f92672>(</span>RPMs<span style=color:#f92672>)</span>                                        3.9 kB/s | 4.1 kB     00:01    
</span></span><span style=display:flex><span>Red Hat Enterprise Linux <span style=color:#ae81ff>9</span> <span style=color:#66d9ef>for</span> x86_64 - AppStream <span style=color:#f92672>(</span>RPMs<span style=color:#f92672>)</span>                                     3.9 kB/s | 4.1 kB     00:01    
</span></span><span style=display:flex><span>Dependencies resolved.
</span></span><span style=display:flex><span><span style=color:#f92672>=============================================================================================================================</span>
</span></span><span style=display:flex><span> Package                          Architecture              Version                    Repository                       Size
</span></span><span style=display:flex><span><span style=color:#f92672>=============================================================================================================================</span>
</span></span><span style=display:flex><span>Installing:
</span></span><span style=display:flex><span> elasticsearch                    x86_64                    8.5.0-1                    @commandline                    <span style=color:#ae81ff>540</span> M
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Transaction Summary
</span></span><span style=display:flex><span><span style=color:#f92672>=============================================================================================================================</span>
</span></span><span style=display:flex><span>Install  <span style=color:#ae81ff>1</span> Package
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total size: <span style=color:#ae81ff>540</span> M
</span></span><span style=display:flex><span>Installed size: 1.1 G
</span></span><span style=display:flex><span>Is this ok <span style=color:#f92672>[</span>y/N<span style=color:#f92672>]</span>: y
</span></span><span style=display:flex><span>Downloading Packages:
</span></span><span style=display:flex><span>Running transaction check
</span></span><span style=display:flex><span>Transaction check succeeded.
</span></span><span style=display:flex><span>Running transaction test
</span></span><span style=display:flex><span>Transaction test succeeded.
</span></span><span style=display:flex><span>Running transaction
</span></span><span style=display:flex><span>  Preparing        :                                                                                                     1/1 
</span></span><span style=display:flex><span>  Running scriptlet: elasticsearch-8.5.0-1.x86_64                                                                        1/1 
</span></span><span style=display:flex><span>Creating elasticsearch group... OK
</span></span><span style=display:flex><span>Creating elasticsearch user... OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Installing       : elasticsearch-8.5.0-1.x86_64                                                                        1/1 
</span></span><span style=display:flex><span>  Running scriptlet: elasticsearch-8.5.0-1.x86_64                                                                        1/1 
</span></span><span style=display:flex><span>--------------------------- Security autoconfiguration information ------------------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Authentication and authorization are enabled.
</span></span><span style=display:flex><span>TLS <span style=color:#66d9ef>for</span> the transport and HTTP layers is enabled and configured.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The generated password <span style=color:#66d9ef>for</span> the elastic built-in superuser is : guJrLagKN5bsmUh72bha
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If this node should join an existing cluster, you can reconfigure this with
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;/usr/share/elasticsearch/bin/elasticsearch-reconfigure-node --enrollment-token &lt;token-here&gt;&#39;</span>
</span></span><span style=display:flex><span>after creating an enrollment token on your existing cluster.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You can complete the following actions at any time:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Reset the password of the elastic built-in superuser with 
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic&#39;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Generate an enrollment token <span style=color:#66d9ef>for</span> Kibana instances with 
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#39;/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana&#39;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Generate an enrollment token <span style=color:#66d9ef>for</span> Elasticsearch nodes with 
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node&#39;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span><span style=color:#75715e>### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd</span>
</span></span><span style=display:flex><span> sudo systemctl daemon-reload
</span></span><span style=display:flex><span> sudo systemctl enable elasticsearch.service
</span></span><span style=display:flex><span><span style=color:#75715e>### You can start elasticsearch service by executing</span>
</span></span><span style=display:flex><span> sudo systemctl start elasticsearch.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/lib/tmpfiles.d/elasticsearch.conf:1: Line references path below legacy directory /var/run/, updating /var/run/elasticsearch → /run/elasticsearch; please update the tmpfiles.d/ drop-in file accordingly.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Verifying        : elasticsearch-8.5.0-1.x86_64                                                                        1/1 
</span></span><span style=display:flex><span>Installed products updated.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Installed:
</span></span><span style=display:flex><span>  elasticsearch-8.5.0-1.x86_64                                                                                               
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Complete!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@elk-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span></code></pre></div><p>安装完毕之后，查看 Elasticsearch 配置文件的默认参数：<code>egrep -v "#|^$" /etc/elasticsearch/elasticsearch.yml</code>；用 vi 编辑器打开 <code>vi /etc/elasticsearch/elasticsearch.yml</code> 配置文件 ； 在这个默认配置文件中寻找类似这样的一行 <code>cluster.initial_master_nodes: ["elk-01"]</code> ；将这一行注释掉。</p><p>然后在此配置文件的最下面增加下面这几行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>cluster.name</span>: <span style=color:#ae81ff>test-elk-015</span>
</span></span><span style=display:flex><span><span style=color:#f92672>discovery.type</span>: <span style=color:#ae81ff>single-node</span>
</span></span><span style=display:flex><span><span style=color:#f92672>network.host</span>: <span style=color:#ae81ff>192.168.10.113</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.security.authc.api_key.enabled</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>启动 Elasticsearch 服务，并查看服务的状态。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl daemon-reload
</span></span><span style=display:flex><span>systemctl enable elasticsearch.service
</span></span><span style=display:flex><span>systemctl start elasticsearch.service
</span></span><span style=display:flex><span>systemctl status elasticsearch
</span></span></code></pre></div><p>在使用 ES 前，可以先修改ES服务初始化的内建用户密码，改成自己好记的安全可控密码。否则需要到 ES 的启动日志里寻找系统自动生产的管理员密码。</p><p>运行 <code>/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -i</code> 命令修改 ES 的管理员账号 elastic 的密码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@elk-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -i</span>
</span></span><span style=display:flex><span>This tool will reset the password of the <span style=color:#f92672>[</span>elastic<span style=color:#f92672>]</span> user.
</span></span><span style=display:flex><span>You will be prompted to enter the password.
</span></span><span style=display:flex><span>Please confirm that you would like to <span style=color:#66d9ef>continue</span> <span style=color:#f92672>[</span>y/N<span style=color:#f92672>]</span>y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Enter password <span style=color:#66d9ef>for</span> <span style=color:#f92672>[</span>elastic<span style=color:#f92672>]</span>: 
</span></span><span style=display:flex><span>Re-enter password <span style=color:#66d9ef>for</span> <span style=color:#f92672>[</span>elastic<span style=color:#f92672>]</span>: 
</span></span><span style=display:flex><span>Password <span style=color:#66d9ef>for</span> the <span style=color:#f92672>[</span>elastic<span style=color:#f92672>]</span> user successfully reset.
</span></span></code></pre></div><p>在启动 ES 服务前，打开后续测试所需要的防火墙端口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>firewall-cmd --permanent --add-port<span style=color:#f92672>=</span>9200/tcp
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-port<span style=color:#f92672>=</span>5601/tcp
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-port<span style=color:#f92672>=</span>8220/tcp
</span></span><span style=display:flex><span>firewall-cmd --permanent --add-port<span style=color:#f92672>=</span>80/tcp
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><p>在浏览器里访问 es 的访问网址 https://192.168.10.133:9200/ ，忽略关于证书的安全提示，输入上面所修改的 elastic 账户信息，测试是否可以正常登录。</p><h2 id=安装-kibana>安装 Kibana</h2><p>在虚拟机 A 上完成本章节操作。</p><p>下载 Kibana 的 rpm 安装包到服务器，然后执行 <code>dnf install kibana-8.5.0-x86_64.rpm</code> 安装命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@elk-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># dnf install kibana-8.5.0-x86_64.rpm </span>
</span></span><span style=display:flex><span>Updating Subscription Management repositories.
</span></span><span style=display:flex><span>Last metadata expiration check: 0:22:56 ago on Sun <span style=color:#ae81ff>16</span> Oct <span style=color:#ae81ff>2022</span> 02:20:20 PM CST.
</span></span><span style=display:flex><span>Dependencies resolved.
</span></span><span style=display:flex><span><span style=color:#f92672>=======================================================================================================================================</span>
</span></span><span style=display:flex><span> Package                       Architecture                  Version                         Repository                           Size
</span></span><span style=display:flex><span><span style=color:#f92672>=======================================================================================================================================</span>
</span></span><span style=display:flex><span>Installing:
</span></span><span style=display:flex><span> kibana                        x86_64                        8.5.0-1                         @commandline                        <span style=color:#ae81ff>274</span> M
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Transaction Summary
</span></span><span style=display:flex><span><span style=color:#f92672>=======================================================================================================================================</span>
</span></span><span style=display:flex><span>Install  <span style=color:#ae81ff>1</span> Package
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total size: <span style=color:#ae81ff>274</span> M
</span></span><span style=display:flex><span>Installed size: <span style=color:#ae81ff>649</span> M
</span></span><span style=display:flex><span>Is this ok <span style=color:#f92672>[</span>y/N<span style=color:#f92672>]</span>: y
</span></span><span style=display:flex><span>Downloading Packages:
</span></span><span style=display:flex><span>Running transaction check
</span></span><span style=display:flex><span>Transaction check succeeded.
</span></span><span style=display:flex><span>Running transaction test
</span></span><span style=display:flex><span>Transaction test succeeded.
</span></span><span style=display:flex><span>Running transaction
</span></span><span style=display:flex><span>  Preparing        :                                                                                                               1/1 
</span></span><span style=display:flex><span>  Running scriptlet: kibana-8.5.0-1.x86_64                                                                                         1/1 
</span></span><span style=display:flex><span>  Installing       : kibana-8.5.0-1.x86_64                                                                                         1/1 
</span></span><span style=display:flex><span>  Running scriptlet: kibana-8.5.0-1.x86_64                                                                                         1/1 
</span></span><span style=display:flex><span>Creating kibana group... OK
</span></span><span style=display:flex><span>Creating kibana user... OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Created Kibana keystore in /etc/kibana/kibana.keystore
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/lib/tmpfiles.d/elasticsearch.conf:1: Line references path below legacy directory /var/run/, updating /var/run/elasticsearch → /run/elasticsearch; please update the tmpfiles.d/ drop-in file accordingly.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Verifying        : kibana-8.5.0-1.x86_64                                                                                         1/1 
</span></span><span style=display:flex><span>Installed products updated.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Installed:
</span></span><span style=display:flex><span>  kibana-8.5.0-1.x86_64                                                                                                                
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Complete!
</span></span></code></pre></div><p>在启动 Kiban 服务器之前，先需要创建 Kibana 需要的各种加密 key ，执行这个 <code>/usr/share/kibana/bin/kibana-encryption-keys generate</code> 命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/share/kibana/bin/kibana-encryption-keys generate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xpack.encryptedSavedObjects.encryptionKey: 2e71f1b16031c2b111b76276268dbf9e
</span></span><span style=display:flex><span>xpack.reporting.encryptionKey: 84cb58b5e944fa9f65f73382384612a5
</span></span><span style=display:flex><span>xpack.security.encryptionKey: c5ac5b306ee011838a67e2eaf4154dd0
</span></span></code></pre></div><p>记录以上三行配置参数，并增加2行新参数，将它们全部添加到 Kibana 默认的配置文件中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server.host</span>:  <span style=color:#ae81ff>192.168.10.113</span>
</span></span><span style=display:flex><span><span style=color:#f92672>server.publicBaseUrl</span>: <span style=color:#e6db74>&#34;http://192.168.10.113:5601&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.encryptedSavedObjects.encryptionKey</span>: <span style=color:#ae81ff>2e71f1b16031c2b111b76276268dbf9e</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.reporting.encryptionKey</span>: <span style=color:#ae81ff>84cb58b5e944fa9f65f73382384612a5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.security.encryptionKey</span>: <span style=color:#ae81ff>c5ac5b306ee011838a67e2eaf4154dd0</span>
</span></span></code></pre></div><p>用 vi 打开 Kibana 的默认配置文件 <code>/etc/kibana/kibana.yml</code> ，将上面的 5 行配置参数添加到文件中。</p><p>在命令行执行 <code>systemctl enable --now kibana</code> 命令启动 Kibana 服务器.</p><p>然后执行命令 <code>tail -f /var/log/messages</code> ， 在日志中寻找 Kibana 服务启动的信息，等待出现 Kibana 配置的访问 URL。在日志中寻找类似这样的信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>Oct <span style=color:#ae81ff>18</span> 10:36:48 elk-01 kibana<span style=color:#f92672>[</span>2163<span style=color:#f92672>]</span>: i Kibana has not been configured.
</span></span><span style=display:flex><span>Oct <span style=color:#ae81ff>18</span> 10:36:48 elk-01 kibana<span style=color:#f92672>[</span>2163<span style=color:#f92672>]</span>: Go to http://192.168.10.113:5601/?code<span style=color:#f92672>=</span><span style=color:#ae81ff>732948</span> to get started.
</span></span></code></pre></div><p>然后在浏览器中打开这个类似这个 <code>http://192.168.1.113:5601/?code=732948</code> 网址。网页中会出现一个大输入框，等待输入Kibana 注册秘钥。</p><p>在命令行执行 <code>/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana</code> 命令，从而获取 Kibana 的注册令牌。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@elk-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana</span>
</span></span><span style=display:flex><span>eyJ2ZXIiOiI4LjQuMyIsImFkciI6WyIxOTIuMTY4LjEwLjEwOjkyMDAiXSwiZmdyIjoiZTdlOTdlZWU2YWVlYjVmYTczZWM1YTVkNzBiNDJkZGUzZjlkZmNjMDJhNTVmZDcwZjAxOTQwZmExNzE5YWM2MSIsImtleSI6IjNHLVEzNE1CYnA4c3p4TEZEZXpCOk0wUDMzRC1VVFAyT0ZxQVFBekNKSWcifQ<span style=color:#f92672>==</span>
</span></span></code></pre></div><p>将这个 Token 复制到网页里，完成Kibana 的初始化配置，最后用 es 的管理员账号登录 Kibana。</p><p>安装完成 Kibana 之后，启用试用版许可证，启用集群自监控功能。</p><h2 id=安装-fleet-服务器>安装 Fleet 服务器</h2><p>在虚拟机 A 上完成本章节操作。</p><p>在 Kibana 的菜单中找到， Fleet 选项，点击 Settings，然后点击 Edit Hosts ，选择增加 Fleet server 配置信息，输入 <code>https://192.168.1.113:8220</code> ，注意这里必须是 https协议。</p><p>回到 Fleet 主页，找到 agent 管理的地方，按照流程做，点击创建 Fleet Server 配置。然后就会在页面上生成 Fleet 服务器的安装配置命令。</p><p><img src=/images/2022-10-18_10-46-39.png alt="Fleet server"></p><p>按着提示的命令参数安装 Fleet 服务器。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>tar xzvf elastic-agent-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>cd elastic-agent-8.5.0-linux-x86_64
</span></span><span style=display:flex><span>sudo ./elastic-agent install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --fleet-server-es<span style=color:#f92672>=</span>https://192.168.10.113:9200 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --fleet-server-service-token<span style=color:#f92672>=</span>AAEAAWVsYXN0aWMvZmxlZXQtc2VydmVyL3Rva2VuLTE2Njc3Mjk3Mzc3MTQ6ZWRFNGtlWGJTSWU1TktJTXRtR0U5QQ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --fleet-server-policy<span style=color:#f92672>=</span>fleet-server-policy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --fleet-server-es-ca-trusted-fingerprint<span style=color:#f92672>=</span>772b777ed4dd557965cb3e1735f7b15b8cd6312372e8ba4d967f55d8beecd702
</span></span></code></pre></div><p>在 Fleet 服务器正常启动以后，上面创建 Fleet 服务器配置的网页上的最后一步就会显示：Fleet 服务器已经连接正常，等待注册 Elastic Agent 。这样表明 Fleet 服务器已经安装正常，并且运行在默认的代理配置采集策略下。</p><p>可以在 Kibana 的界面里查看 Fleet 服务器的监控信息。点击 Kibana 左上角的菜单：Observability -> Infrastructure -> Inventory ，即可看到 Fleet 服务器的监控数据。</p><h2 id=搭建本地安装包下载服务器>搭建本地安装包下载服务器</h2><p>为了让局域网中的被管理操作系统能在本地局域网里下载到 Elastic Stack 技术栈中，所有可以通过 Fleet 服务器管理（安装、配置、升级、删除等）的组件，我们可以参考文档的方法：<a href=https://www.elastic.co/guide/en/fleet/8.5/air-gapped.html#host-artifact-registry>https://www.elastic.co/guide/en/fleet/8.5/air-gapped.html#host-artifact-registry</a>在本地部署一个安装包下载服务器。</p><p>首先，安装一个 Nginx 服务器，在根目录下创建目录 downloads ，并且运行下面的下载脚本。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/heartbeat/heartbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/heartbeat/heartbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/heartbeat/heartbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/osquerybeat/osquerybeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/osquerybeat/osquerybeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/osquerybeat/osquerybeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/packetbeat/packetbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/packetbeat/packetbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/beats/packetbeat/packetbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/cloudbeat/cloudbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/cloudbeat/cloudbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/cloudbeat/cloudbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/endpoint-dev/endpoint-security-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/endpoint-dev/endpoint-security-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/endpoint-dev/endpoint-security-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/fleet-server/fleet-server-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/fleet-server/fleet-server-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>curl -O https://artifacts.elastic.co/downloads/fleet-server/fleet-server-8.5.0-linux-x86_64.tar.gz.asc
</span></span></code></pre></div><p>将下载后的目录结构整理的和下载路径一致，建立所有必要的子目录，整理之后的目录结构如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@elk-01 html<span style=color:#f92672>]</span><span style=color:#75715e># tree downloads/</span>
</span></span><span style=display:flex><span>downloads/
</span></span><span style=display:flex><span>├── apm-server
</span></span><span style=display:flex><span>│   ├── apm-server-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   ├── apm-server-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   └── apm-server-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>├── beats
</span></span><span style=display:flex><span>│   ├── auditbeat
</span></span><span style=display:flex><span>│   │   ├── auditbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   │   ├── auditbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   │   └── auditbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>│   ├── elastic-agent
</span></span><span style=display:flex><span>│   │   ├── elastic-agent-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   │   ├── elastic-agent-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   │   └── elastic-agent-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>│   ├── filebeat
</span></span><span style=display:flex><span>│   │   ├── filebeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   │   ├── filebeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   │   └── filebeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>│   ├── heartbeat
</span></span><span style=display:flex><span>│   │   ├── heartbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   │   ├── heartbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   │   └── heartbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>│   ├── metricbeat
</span></span><span style=display:flex><span>│   │   ├── metricbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   │   ├── metricbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   │   └── metricbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>│   ├── osquerybeat
</span></span><span style=display:flex><span>│   │   ├── osquerybeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   │   ├── osquerybeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   │   └── osquerybeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>│   └── packetbeat
</span></span><span style=display:flex><span>│       ├── packetbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│       ├── packetbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│       └── packetbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>├── cloudbeat
</span></span><span style=display:flex><span>│   ├── cloudbeat-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   ├── cloudbeat-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   └── cloudbeat-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>├── endpoint-dev
</span></span><span style=display:flex><span>│   ├── endpoint-security-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   ├── endpoint-security-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   └── endpoint-security-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>├── fleet-server
</span></span><span style=display:flex><span>│   ├── fleet-server-8.5.0-linux-x86_64.tar.gz
</span></span><span style=display:flex><span>│   ├── fleet-server-8.5.0-linux-x86_64.tar.gz.asc
</span></span><span style=display:flex><span>│   └── fleet-server-8.5.0-linux-x86_64.tar.gz.sha512
</span></span><span style=display:flex><span>└── pull-bin.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span> directories, <span style=color:#ae81ff>34</span> files
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@elk-01 html<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span></code></pre></div><p>注意：以上不包含 windows 和 macos 平台的软件包，如果有必要，还需要自行填补完整。</p><p>为了方便查看这个目录的内容，修改 nginx 的默认配置文件，在 http 这个部分增加下面三个参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>    <span style=color:#ae81ff>autoindex on; </span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>autoindex_exact_size off;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>autoindex_localtime on; </span>
</span></span></code></pre></div><p>重启 Nginix 服务器后，在浏览器中可以访问： <a href=http://192.168.10.113/downloads/>http://192.168.10.113/downloads/ </a>，确保可以看到正确的目录结构和文件。</p><p><img src=/images/2022-10-21_16-24-03.png alt="Agent Binary Download"></p><p>进入 Fleet 的配置页面，在 <code>Agent Binary Download</code> 下面点击 “Add agent binary source” ，新建一个新的代理安装包下载来源网站。</p><p><img src=/images/2022-10-18_14-21-44.png alt="Agent Binary Download"></p><p>在 Agent Policies 页面新建一个新的测试用 Agent 管理策略，名为 “my-policy2”；进入这个策略的配置界面，修改 <em>Agent Binary Download</em> 为刚才创建的下载源。保存并测试这个策略。</p><p><img src=/images/2022-10-18_14-25-35.png alt></p><p>点击 “Add agent” 连接，获取下面的新注册代理注册命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz tar xzvf elastic-agent-8.5.0-linux-x86_64.tar.gz cd elastic-agent-8.5.0-linux-x86_64 sudo ./elastic-agent install --url<span style=color:#f92672>=</span>https://192.168.1.113:8220 --enrollment-token<span style=color:#f92672>=</span>R29qRDZZTUJtUENhc0ZFTFNDSW06bVFOeW5vcUpTQmFmZDBwLUgyTDBYZw<span style=color:#f92672>==</span>
</span></span></code></pre></div><p>修改这些命令参数，将 tar.gz 的下载地址改为本地搭建的下载服务器地址，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L -O http://192.168.10.10/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz 
</span></span><span style=display:flex><span>tar xzvf elastic-agent-8.5.0-linux-x86_64.tar.gz 
</span></span><span style=display:flex><span>cd elastic-agent-8.5.0-linux-x86_64 
</span></span><span style=display:flex><span>sudo ./elastic-agent install --url<span style=color:#f92672>=</span>https://192.168.1.113:8220 --enrollment-token<span style=color:#f92672>=</span>R29qRDZZTUJtUENhc0ZFTFNDSW06bVFOeW5vcUpTQmFmZDBwLUgyTDBYZw<span style=color:#f92672>==</span>  --insecure
</span></span></code></pre></div><p>用新创建的 Agent 管理策略，一键式安装 Elastic Agent 并注册到 Fleet 服务器。由于这个策略使用了本地的安装包（默认会使用到 Filebeat 和 Metricbeat），所以它的部署速度应该会比较快。</p><p>Elastic Agent 的常用命令：</p><ul><li>用这个命令 <code>elastic-agent status</code> 也可以确认当前的运行状态和模块。</li><li>用这个命令 <code>elastic-agent inspect</code> 也可以确认Fleet 服务器下发过来的配置。</li></ul><h2 id=安装-elastic-agent-监控代理>安装 Elastic Agent 监控代理</h2><p>在虚拟机 B 上完成本章节操作。</p><p>在 Fleet 的管理界面中新增一个名为 my-policy1 的管理策略，避免和 Fleet 服务器使用相同的策略。点击 Add agent 连接，获取如下代理注册命令。</p><p><img src=/images/2022-10-21_16-14-50.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz 
</span></span><span style=display:flex><span>tar xzvf elastic-agent-8.5.0-linux-x86_64.tar.gz 
</span></span><span style=display:flex><span>cd elastic-agent-8.5.0-linux-x86_64 
</span></span><span style=display:flex><span>sudo ./elastic-agent install --url<span style=color:#f92672>=</span>https://192.168.1.113:8220 --enrollment-token<span style=color:#f92672>=</span>NW9ZTjZZTUJtUENhc0ZFTDI5SV86MkZQT1hlc2dUOEdWZnRrWWhNbXVjdw<span style=color:#f92672>==</span>  
</span></span></code></pre></div><p>将上面的命令复制到一个写字板中，修改其中的两条命令：</p><ol><li>修改下载网址为前文所搭建的本地下载网址</li><li>修改最后一条命令，在最后增加<code>--insecure</code> 参数，如果不加这个参数，远程 Agent 的注册就会由于验证 es 服务器端证书而失败。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl -L -O http://192.168.10.113/downloads/beats/elastic-agent/elastic-agent-8.5.0-linux-x86_64.tar.gz 
</span></span><span style=display:flex><span>tar xzvf elastic-agent-8.5.0-linux-x86_64.tar.gz 
</span></span><span style=display:flex><span>cd elastic-agent-8.5.0-linux-x86_64 
</span></span><span style=display:flex><span>sudo ./elastic-agent install --url<span style=color:#f92672>=</span>https://192.168.10.113:8220 --enrollment-token<span style=color:#f92672>=</span>RHVudFRJUUIzZTZQd0tCdlhBTFY6NldXMFlVellUYmFrdVc4UGRHUDVSdw<span style=color:#f92672>==</span>  --insecure
</span></span></code></pre></div><p>通过执行上面的命令，我们就在被管理服务器上，一键式的安装了用于数据采集功能的 Elastic Agent ，并将其注册到 Fleet 服务器上。</p><p>Elatic Agent 正常运行几分钟有，既可以在 Kibana 中的 Observability 的界面和 Dashbard 中看到这个被管理服务器的监控数据。</p><p>Elastic Agent 的安装方式：</p><ul><li>tar.gz : 在所有操作系统上「Windows，Linux，MacOS」都推荐，由于这里下载的 tar.gz 的安装包，用命令行一键式的安装成功以后，在操作系统中就会创建出后台的 Elastic Agent 主服务，这个服务进程会自动化其他所有 Beats 程序的安装工作，根据 Agent 策略，如果需要安装新的 Beats 就会下载安装，如果有新的版本就会根据策略升级，这样就解决了后续 Agent 这一侧的配置的生命周期管理。</li><li>PRM、DEB ： 这种方式也支持，但是 Elastic Agent 软件/服务本身的版本升级无法自动化实现。</li></ul><h2 id=万用采集端的好处新增-packetbeat-采集模块>万用采集端的好处，新增 Packetbeat 采集模块</h2><p>在虚拟机 A&B 上完成本章节操作。</p><p>为了验证这个功能，可以尝试更新当前的一个 policy，在其中增加 Packetbeat 数据采集能力。操作步骤如下：</p><ol><li>打开当前的一个正在使用中 policy</li><li>点击 Add intergation 按钮，在众多选项中选择 Network Packet Capture 模块。</li><li>增加新的采集模块后，保存这个策略。</li><li>它更新了版本，观察 Fleet 界面上所有使用这个策略的节点的状态变化。</li><li>这些节点会自动的，很快的更新到新的管理策略中，Elastic Agent 会自动化安装 Packetbeat 采集模块。</li><li>返回 Kiban ，进入安全管理解决方案，我们可以看到 Filebeat 和 Packetbeat 的采集结果。</li></ol><p><img src=/images/2022-10-18_22-49-08.png alt="添加 Packetbeat 模块"></p><p>在策略更新了以后，我们没有在 Elastic Agent 端做任何操作，它就已经自动化的下载新的策略，并更新了自身。</p><p><img src=/images/2022-10-18_22-53-55.png alt="查看 安全管理解决方案"></p><h2 id=常见问题>常见问题</h2><p>Elastic Agent 在采集数据的服务上安装正常，在 Fleet 服务器的管理界面中也可以看到其状态正常。但是在可观测性的页面中看不到它的任何数据。 主要是由于 Elasticsearch 服务器强制是用 https 协议，客户端没有配置好数字证书的话，必须在Fleet服务器的配置中规避掉，ssl 证书校验的功能。</p><p>其他可能的原因：Elastic Agent 采集端程序和 ES 后台服务器的通讯不正常，检查 9200 端口，用 curl + ES 服务器端的数字证书，用户名和密码，尝试访问 ES 的服务地址 <code>https://192.168.10.10:9200</code>。</p><p>也可以尝试在 Fleet 的管理页面上删除这个 Agent；然后在被管理服务器上，用命令 <code>elastic-agent uninstall</code> 删除服务，然后重新安装注册这个被管理服务器，注意在注册命令的最后面可以尝试增加这两个参数：<code> --insecure --fleet-server-es-insecure</code> 第一个参数是忽略 Fleet 服务器的 ssl 证书校验，第二个参数是忽略 es 服务器的 ssl 证书校验。或者尝试重新手工安装一遍 es 服务器上的 ca 根证书。</p><div class=edit-meta>Last updated on 2022-11-06<br>Published on 2022-11-06<br><a href=https://github.com/martinliu/elasticstack-workshop/edit/master/content/chapter3/chapter3-1/5.md class=edit-page><i class="fas fa-pen-square"></i>&nbsp;Edit on GitHub</a></div><nav class=pagination><a class="nav nav-prev" href=https://elastic.martinliu.cn/chapter3/chapter3-1/4/ title="使用 rpm/deb 软件包安装 Elasticsearch 8.1.0 "><i class="fas fa-arrow-left" aria-hidden=true></i>&nbsp;Prev - 使用 rpm/deb 软件包安装 Elasticsearch 8.1.0</a>
<a class="nav nav-next" href=https://elastic.martinliu.cn/chapter3/enterprise-search/5/ title="Enterprise Search">Next - Enterprise Search <i class="fas fa-arrow-right" aria-hidden=true></i></a></nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p></footer></main><div class=sidebar><nav class=slide-menu><ul><li><a href=https://elastic.martinliu.cn/>Home</a></li><li class=has-sub-menu><a href=https://elastic.martinliu.cn/getting-started/>新手入门<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=https://elastic.martinliu.cn/getting-started/configuration/>Configuration</a></li><li><a href=https://elastic.martinliu.cn/getting-started/screenshot/>Screenshot</a></li><li class=has-sub-menu><a href=https://elastic.martinliu.cn/getting-started/local/>本地安装<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=https://elastic.martinliu.cn/getting-started/local/installation-macos/>MacOS 本地安装</a></li><li><a href=https://elastic.martinliu.cn/getting-started/local/installation-linux/>Linux 本地安装</a></li><li><a href=https://elastic.martinliu.cn/getting-started/local/installation-win/>Windows 本地安装</a></li></ul></li></ul></li><li class=has-sub-menu><a href=https://elastic.martinliu.cn/chapter1/>新手 100 系列<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=https://elastic.martinliu.cn/chapter1/1/>在 CentOS 上安装 Elastic Stack 7.16</a></li><li><a href=https://elastic.martinliu.cn/chapter1/2/>洞察 GitHub 开源项目的开发效能</a></li><li><a href=https://elastic.martinliu.cn/chapter1/3/>Chapter 1-3</a></li><li><a href=https://elastic.martinliu.cn/chapter1/4/>Chapter 1-4</a></li></ul></li><li class=has-sub-menu><a href=https://elastic.martinliu.cn/sample/>编写规范<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=https://elastic.martinliu.cn/sample/markdown-syntax/>MD基础语法</a></li><li><a href=https://elastic.martinliu.cn/sample/table-of-contents/>内容目录</a></li><li><a href=https://elastic.martinliu.cn/sample/build-in-shortcodes/>内置短代码</a></li><li><a href=https://elastic.martinliu.cn/sample/custom-shortcodes/>自定义短代码</a></li><li><a href=https://elastic.martinliu.cn/sample/search-shortcode/>搜索短代码</a></li></ul></li><li class="parent has-sub-menu"><a href=https://elastic.martinliu.cn/chapter3/>Mini 系列<span class="mark opened">-</span></a><ul class=sub-menu><li><a href=https://elastic.martinliu.cn/chapter3/beats/3/>Beats</a></li><li class="parent has-sub-menu"><a href=https://elastic.martinliu.cn/chapter3/chapter3-1/>Elasticsearch<span class="mark opened">-</span></a><ul class=sub-menu><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-1/1/>在 macOS 上运行 Elasticsearch 8.1.0</a></li><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-1/2/>在 Windows 10 上运行 Elasticsearch 8.1.0</a></li><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-1/3/>在 Linux 上运行 Elasticsearch 8.1.0</a></li><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-1/4/>使用 rpm/deb 软件包安装 Elasticsearch 8.1.0</a></li><li class=active><a href=https://elastic.martinliu.cn/chapter3/chapter3-1/5/>Elastic Stack Fleet 服务器配置指南（v8.5）</a></li></ul></li><li><a href=https://elastic.martinliu.cn/chapter3/enterprise-search/5/>Enterprise Search</a></li><li class=has-sub-menu><a href=https://elastic.martinliu.cn/chapter3/chapter3-2/>Kibana<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-2/2/>Chapter 3-2-2</a></li><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-2/3/>Chapter 3-2-3</a></li><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-2/4/>Chapter 3-2-4</a></li><li><a href=https://elastic.martinliu.cn/chapter3/chapter3-2/1/>在 macOS 上运行 Kibana</a></li></ul></li><li><a href=https://elastic.martinliu.cn/chapter3/logstash/4/>Logstash</a></li></ul></li></ul></nav><div class=sidebar-footer></div></div></div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20><span class="fa-layers fa-fw"><i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i></span></a></div></body></html>